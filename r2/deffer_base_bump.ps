#include "common.h"
#include "sload.h"

f_deffer main(p_bumped I)
{
	f_deffer O;
	surface_bumped S = sload(I);
	half3 Ne = mul(half3x3(I.M1, I.M2, I.M3), S.normal);
	Ne = normalize(Ne);

	half ms = xmaterial;
#ifdef USE_LM_HEMI
	half4 lm = tex2D(s_hemi, I.lmh);
	#ifndef USE_F32
		half h = dot(lm.rgb,1.h/3.h);
	#else
		half h = dot(lm.rgb,1.h/4.h);
	#endif
# ifdef USE_R2_STATIC_SUN
	ms = lm.w;
# endif
#else
	half h = I.position.w;
#ifdef USE_R2_STATIC_SUN
	ms = I.tcdh.w;
# endif
#endif

	O.Ne = half4(Ne, h);
	O.position = half4(I.position.xyz + Ne*S.height*def_virtualh, ms);
	O.C = half4(S.base.xyz, S.gloss);

  return O;
}
